# SPDX-FileCopyrightText: Magenta ApS <https://magenta.dk>
# SPDX-License-Identifier: MPL-2.0
import asyncio
from uuid import UUID

import click
import structlog.stdlib
from more_itertools import one

from scripts.common import get_gql_client
from sdtoolplus.autogenerated_graphql_client import GraphQLClient
from sdtoolplus.autogenerated_graphql_client import OrganisationUnitCreateInput
from sdtoolplus.autogenerated_graphql_client import OrganisationUnitFilter
from sdtoolplus.autogenerated_graphql_client import RAValidityInput
from sdtoolplus.mo.timelines.common import get_class
from sdtoolplus.mo_org_unit_importer import OrgUnitUUID

logger = structlog.stdlib.get_logger()


async def process_unit(
    gql_client: GraphQLClient,
    pay_org_unit_uuid: OrgUnitUUID,
    parent_uuid: OrgUnitUUID,
    pay_org_root_uuid: OrgUnitUUID,
    org_unit_type: UUID,
) -> None:
    r_ou = await gql_client.get_org_unit(
        OrganisationUnitFilter(uuids=[pay_org_unit_uuid])
    )

    ou_obj = one(r_ou.objects)
    ou_validity = one(ou_obj.validities)

    logger.info(
        "Create pay OU adm org equivalent",
        pay_org_unit_uuid=str(pay_org_unit_uuid),
        parent_uuid=str(parent_uuid),
    )

    adm_org_unit_uuid = (
        await gql_client.create_org_unit(
            OrganisationUnitCreateInput(
                validity=RAValidityInput(from_=ou_validity.validity.from_),
                name=ou_validity.name,
                user_key=ou_validity.user_key,
                parent=parent_uuid,
                org_unit_type=org_unit_type,
            )
        )
    ).uuid

    logger.info(
        "Created OU",
        pay_org_unit_uuid=str(pay_org_unit_uuid),
        adm_org_unit_uuid=str(adm_org_unit_uuid),
        parent_uuid=str(parent_uuid),
    )

    input("Press Enter to continue...")

    for child in ou_validity.children:
        await process_unit(
            gql_client=gql_client,
            pay_org_unit_uuid=child.uuid,
            parent_uuid=adm_org_unit_uuid,
            pay_org_root_uuid=pay_org_root_uuid,
            org_unit_type=org_unit_type,
        )


async def build_adm_org(
    gql_client: GraphQLClient,
    pay_org_root: OrgUnitUUID,
    adm_org_root: OrgUnitUUID,
) -> None:
    # Get the OU type UUID
    ou_type_uuid = await get_class(
        gql_client=gql_client,
        facet_user_key="org_unit_type",
        class_user_key="Enhed",
    )

    await process_unit(
        gql_client=gql_client,
        pay_org_unit_uuid=pay_org_root,
        parent_uuid=adm_org_root,
        pay_org_root_uuid=pay_org_root,
        org_unit_type=ou_type_uuid,
    )


@click.command()
@click.option("--pay-org-root-uuid", type=click.UUID, required=True)
@click.option("--adm-org-root-uuid", type=click.UUID, required=True)
def main(
    pay_org_root_uuid: UUID,
    adm_org_root_uuid: UUID,
) -> None:
    logger.info("Script started")

    gql_client = get_gql_client()

    asyncio.run(build_adm_org(gql_client, pay_org_root_uuid, adm_org_root_uuid))

    logger.info("Script finished")


if __name__ == "__main__":
    main()
